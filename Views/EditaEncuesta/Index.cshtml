@model EncuestasEvaluacionLiderazgo.Models.Encuesta

@{
    ViewData["Title"] = "Editar Encuesta: " + Model.Titulo;
}

<div class="max-w-4xl mx-auto py-8">
    <!-- Encabezado -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Editar Encuesta</h1>
        <p class="text-gray-600">Modifica los detalles y preguntas de tu encuesta</p>
    </div>

    <!-- Informaci√≥n de Estado -->
    <div class="mb-8 p-6 @GetEstadoBgClase(Model.Estado) rounded-lg">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-sm opacity-75">Estado Actual</p>
                <p class="text-lg font-bold">@GetEstadoTexto(Model.Estado)</p>
            </div>
            @if (Model.Estado == EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador)
            {
                <form method="post" asp-action="Publish" asp-route-id="@Model.Id" class="inline">
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-bold">
                        üì§ Publicar Encuesta
                    </button>
                </form>
            }
            @if (Model.Estado != EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Cerrada)
            {
                <form method="post" asp-action="Delete" asp-route-id="@Model.Id" 
                      onsubmit="return confirm('¬øEst√°s seguro de que deseas eliminar esta encuesta? Esta acci√≥n no se puede deshacer.');">
                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition font-bold">
                        üóëÔ∏è Eliminar
                    </button>
                </form>
            }
        </div>
    </div>

    <!-- Tabs/Secciones -->
    <div class="mb-8">
        <ul class="flex border-b border-gray-300">
            <li class="mr-6">
                <button type="button" class="py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-bold active-tab" data-tab="detalles">
                    ‚ÑπÔ∏è Detalles
                </button>
            </li>
            <li class="mr-6">
                <button type="button" class="py-2 px-1 border-b-2 border-transparent text-gray-700 hover:text-gray-900 inactive-tab" data-tab="preguntas">
                    ‚ùì Preguntas (@(Model.Preguntas?.Count ?? 0))
                </button>
            </li>
            <li class="mr-6">
                <button type="button" class="py-2 px-1 border-b-2 border-transparent text-gray-700 hover:text-gray-900 inactive-tab" data-tab="respuestas">
                    üìä Respuestas (@(Model.Respuestas?.Count ?? 0))
                </button>
            </li>
        </ul>
    </div>

    <!-- TAB 1: Detalles -->
    <div id="tab-detalles" class="tab-content">
        <form method="post" asp-action="Update" class="bg-white rounded-lg shadow-md p-8 space-y-6">
            <!-- Validaci√≥n General -->
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                    <p class="font-bold">Errores en el formulario:</p>
                    <ul class="mt-2 space-y-1">
                        @foreach (var modelState in ViewData.ModelState.Values)
                        {
                            @foreach (var error in modelState.Errors)
                            {
                                <li class="text-sm">‚Ä¢ @error.ErrorMessage</li>
                            }
                        }
                    </ul>
                </div>
            }

            <input type="hidden" name="id" value="@Model.Id" />

            <!-- T√≠tulo -->
            <div>
                <label for="titulo" class="block text-gray-700 font-bold mb-2">
                    T√≠tulo <span class="text-red-600">*</span>
                </label>
                <input type="text" id="titulo" name="titulo" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       value="@Model.Titulo"
                       @(Model.Estado != EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador ? "disabled" : "") />
            </div>

            <!-- Descripci√≥n -->
            <div>
                <label for="descripcion" class="block text-gray-700 font-bold mb-2">
                    Descripci√≥n <span class="text-red-600">*</span>
                </label>
                <textarea id="descripcion" name="descripcion" required rows="4"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                          @(Model.Estado != EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador ? "disabled" : "")>@Model.Descripcion</textarea>
            </div>

            <!-- Fecha de Vencimiento -->
            <div>
                <label for="fechaVencimiento" class="block text-gray-700 font-bold mb-2">
                    Fecha de Vencimiento <span class="text-red-600">*</span>
                </label>
                <input type="date" id="fechaVencimiento" name="fechaVencimiento" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       value="@Model.FechaVencimiento.ToString("yyyy-MM-dd")"
                       @(Model.Estado != EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador ? "disabled" : "") />
            </div>

            <!-- Estado -->
            <div class="bg-gray-100 p-4 rounded-lg">
                <p class="text-gray-700"><strong>Estado:</strong> @GetEstadoTexto(Model.Estado)</p>
                <p class="text-gray-600 text-sm mt-2">
                    @if (Model.Estado == EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador)
                    {
                        <span>A√∫n est√°s en fase de edici√≥n. Publica cuando est√©s listo.</span>
                    }
                    else if (Model.Estado == EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Publicada)
                    {
                        <span>Los participantes pueden responder esta encuesta.</span>
                    }
                    else
                    {
                        <span>Esta encuesta ya no acepta respuestas.</span>
                    }
                </p>
            </div>

            <!-- Botones -->
            @if (Model.Estado == EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador)
            {
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-bold">
                        ‚úì Guardar Cambios
                    </button>
                    <a href="javascript:history.back()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition font-bold text-center">
                        ‚Üê Cancelar
                    </a>
                </div>
            }
        </form>
    </div>

    <!-- TAB 2: Preguntas -->
    <div id="tab-preguntas" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-md p-8">
            @if (Model.Preguntas != null && Model.Preguntas.Any())
            {
                <div class="space-y-6">
                    @foreach (var pregunta in Model.Preguntas.OrderBy(p => p.Orden))
                    {
                        <div class="border border-gray-300 rounded-lg p-6 hover:border-blue-500 transition">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <h4 class="text-lg font-bold text-gray-900">@pregunta.Texto</h4>
                                    <p class="text-gray-600 text-sm mt-1">
                                        @GetTipoPreguntaTexto(pregunta.Tipo)
                                        @if (pregunta.Requerida)
                                        {
                                            <span class="ml-2 text-red-600 font-bold">Requerida</span>
                                        }
                                    </p>
                                </div>
                                <div class="flex space-x-2">
                                    <button type="button" class="text-blue-600 hover:text-blue-800">‚úèÔ∏è</button>
                                    <button type="button" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                                </div>
                            </div>

                            @if (pregunta.Opciones != null && pregunta.Opciones.Any())
                            {
                                <div class="mt-4 pl-4 border-l-2 border-gray-300">
                                    <p class="text-gray-700 font-semibold mb-2">Opciones:</p>
                                    <ul class="space-y-1">
                                        @foreach (var opcion in pregunta.Opciones.OrderBy(o => o.Orden))
                                        {
                                            <li class="text-gray-600">‚Ä¢ @opcion.Texto</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }
                </div>

                <button type="button" class="mt-6 w-full bg-blue-100 text-blue-600 py-3 rounded-lg hover:bg-blue-200 transition font-bold">
                    ‚ûï Agregar Pregunta
                </button>
            }
            else
            {
                <div class="text-center py-12">
                    <div class="text-6xl mb-4 opacity-50">‚ùì</div>
                    <p class="text-gray-600 text-lg">No hay preguntas en esta encuesta</p>
                    <button type="button" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-bold">
                        ‚ûï Crear Primera Pregunta
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- TAB 3: Respuestas -->
    <div id="tab-respuestas" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow-md p-8">
            @if (Model.Respuestas != null && Model.Respuestas.Any())
            {
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-gray-700 font-bold">Participante</th>
                                <th class="px-4 py-3 text-left text-gray-700 font-bold">Fecha de Respuesta</th>
                                <th class="px-4 py-3 text-left text-gray-700 font-bold">Estado</th>
                                <th class="px-4 py-3 text-left text-gray-700 font-bold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var respuesta in Model.Respuestas)
                            {
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-3 text-gray-900">@respuesta.Usuario?.Nombre</td>
                                    <td class="px-4 py-3 text-gray-600">@respuesta.FechaRespuesta.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="px-4 py-3">
                                        <span class="@(respuesta.Completada ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800") px-3 py-1 rounded-full text-sm font-bold">
                                            @(respuesta.Completada ? "Completada" : "En progreso")
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <a href="#" class="text-blue-600 hover:underline">Ver detalle</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-12">
                    <div class="text-6xl mb-4 opacity-50">üìä</div>
                    <p class="text-gray-600 text-lg">No hay respuestas a√∫n</p>
                    <p class="text-gray-500 mt-2">Los participantes ver√°n respuestas aqu√≠ cuando completen la encuesta</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cambio de tabs
        document.querySelectorAll('.active-tab, .inactive-tab').forEach(button => {
            button.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                
                // Ocultar todos los tabs
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Mostrar tab seleccionado
                document.getElementById('tab-' + tab).classList.remove('hidden');
                
                // Actualizar estilos de botones
                document.querySelectorAll('.active-tab, .inactive-tab').forEach(btn => {
                    if (btn.getAttribute('data-tab') === tab) {
                        btn.classList.remove('inactive-tab', 'border-transparent', 'text-gray-700');
                        btn.classList.add('active-tab', 'border-blue-500', 'text-blue-600');
                    } else {
                        btn.classList.remove('active-tab', 'border-blue-500', 'text-blue-600');
                        btn.classList.add('inactive-tab', 'border-transparent', 'text-gray-700');
                    }
                });
            });
        });
    </script>
}

@functions {
    private string GetEstadoTexto(EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta estado)
    {
        return estado switch
        {
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador => "Borrador",
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Publicada => "Publicada",
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Cerrada => "Cerrada",
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Archivada => "Archivada",
            _ => "Desconocido"
        };
    }

    private string GetEstadoBgClase(EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta estado)
    {
        return estado switch
        {
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Borrador => "bg-gray-100 text-gray-800",
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Publicada => "bg-green-100 text-green-800",
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Cerrada => "bg-orange-100 text-orange-800",
            EncuestasEvaluacionLiderazgo.Models.EstadoEncuesta.Archivada => "bg-blue-100 text-blue-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

    private string GetTipoPreguntaTexto(EncuestasEvaluacionLiderazgo.Models.TipoPregunta tipo)
    {
        return tipo switch
        {
            EncuestasEvaluacionLiderazgo.Models.TipoPregunta.TextoCorto => "Texto corto",
            EncuestasEvaluacionLiderazgo.Models.TipoPregunta.TextoLargo => "P√°rrafo",
            EncuestasEvaluacionLiderazgo.Models.TipoPregunta.OpcionUnica => "Opci√≥n √∫nica",
            EncuestasEvaluacionLiderazgo.Models.TipoPregunta.OpcionMultiple => "Opciones m√∫ltiples",
            EncuestasEvaluacionLiderazgo.Models.TipoPregunta.Escala => "Escala",
            _ => "Desconocido"
        };
    }
}
